<!DOCTYPE html>
<html>
<head>
  <title>Audio-only実験ページ</title>
  <meta charset="UTF-8">
  <style>
    div.c {
      margin: 0;
      font-size: 20px;
      text-align: center;
    }
    iframe.c{
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="c">
  <br>
  <h1>Audio-only(音声)実験ページ</h1>
  <video class="c" id="video" height="500" width="1000" autoplay></video>
  <br>
  <input type="button" value="実験を開始する" class="btn-flat-border" onClick="prepareVideoOrder(); this.disabled=true;">
  <input type="button" value="次の問題に進む" class="btn-flat-border" onClick="video.play(); video.autoplay = true; this.disabled=true;" id="resumeButton" disabled>
  </div>
  <script type="text/javascript">

    var videolist = [];
    var trialOrder = [];

    // var alphaArray = {a:[1,2,3],b:[1,3,2],c:[2,1,3],d:[2,3,1],e:[3,1,2],f:[3,2,1]};
    // var randNum = shuffle(alphaArray);
    // alphaArray = randNum;

    function prepareVideoOrder(){
      var triad = createRandomOrder(3);

      for (var i = 0; i < triad.length; i++) {
        var tmptmp = triad[i];
        var condOrder = createRandomOrder(3);

        for (var k = 0; k < 3; k++) {
          videoname = "AO" + tmptmp + "-" + condOrder[k] + ".mp4";
          videolist.push(videoname);
        }

        var tmp_condOrder = "";
        switch (condOrder.join('')) {
          case "123":
            tmp_condOrder = "a";
            break;
          case "132":
            tmp_condOrder = "b";
            break;
          case "213":
            tmp_condOrder = "c";
            break;
          case "231":
            tmp_condOrder = "d";
            break;
          case "312":
            tmp_condOrder = "e";
            break;
          case "321":
            tmp_condOrder = "f";
            break;
          default:
            console.log('check');
            break;
        }
        trialOrder.push(String(tmptmp)+tmp_condOrder);
      }

      playVideo();
    }

    //ビデオの再生
    //配列の中身の順番にvideolistを選択

    function playVideo(){
      //読み出し
      var videoorder = 0;
      var video = document.getElementById("video");
      var button_element = document.getElementById('resumeButton')
      video.src = videolist[videoorder];
      video.load();
      video.addEventListener('ended',function(){
        sleep(1500);
        videoorder++;
        video.src = videolist[videoorder];
        console.log(videoorder);
        console.log(videolist[videoorder]);

        if(videoorder % 3 === 0){
          video.pause();
          video.autoplay = false;

          if(videoorder != videolist.length){
            alert("フォームに回答を入力し、次の問題に進んでください");
            button_element.disabled = false;
          } else{
            alert("以下の文字列をコピーし、フォームの回答欄に貼り付けてください   " + trialOrder.join(''));
          }
        }
      });
    }

    function createRandomOrder(n) {
      var condOrder = [];
      var num = 0;

      //再生順決める indexof()文字列を検索　Fisher-Yatesアルゴリズム
      while(num < n){
        var x = Math.floor(Math.random()*n+1);
        var tmp = condOrder.indexOf(x);
        if (tmp == "-1"){
          condOrder.push(x);
        }
        num = condOrder.length;
      }

      return condOrder;
    }

    function shuffle(list) {
      var i = list.length;

      while (--i) {
        var j = Math.floor(Math.random() * (i + 1));
        if (i == j) continue;
        var k = list[i];
        list[i] = list[j];
        list[j] = k;
      }

      return list;
    }

    function sleep(waitMsec) {
      var startMsec = new Date();
      while (new Date() - startMsec < waitMsec);
    }
  </script>
  <br>
  <div class="c">
<iframe class="c" src="https://docs.google.com/forms/d/e/1FAIpQLSfjUeFcQ37yRKK1Pn_NeKTMZ5HWKNMIXUPY4gb97LlDwiTRgA/viewform?embedded=true" width="640" height="1684" frameborder="0" marginheight="0" marginwidth="0">読み込んでいます…</iframe>
  </div>
  </br>
</html>
